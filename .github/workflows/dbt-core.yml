name: DBT Workflow

on:
  workflow_dispatch:  # Enables manual triggering

jobs:
  dbt:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install DBT
      run: |
        python -m pip install --upgrade pip
        pip install dbt-core dbt-snowflake  # Replace 'dbt-snowflake' with your adapter if needed

    - name: Create profiles.yml
      run: |
        mkdir -p ~/.dbt
        echo "
        default:
          outputs:
            dev:
              type: snowflake
              account: '${{ secrets.SNOWFLAKE_ACCOUNT }}'
              user: '${{ secrets.SNOWFLAKE_USER }}'
              password: '${{ secrets.SNOWFLAKE_PASSWORD }}'
              role: '${{ secrets.SNOWFLAKE_ROLE }}'
              database: '${{ secrets.SNOWFLAKE_DATABASE }}'
              warehouse: '${{ secrets.SNOWFLAKE_WAREHOUSE }}'
              schema: '${{ secrets.SNOWFLAKE_SCHEMA }}'
          target: dev
        " > ~/.dbt/profiles.yml

    - name: Validate DBT Setup
      run: dbt debug

    - name: Install Dependencies
      run: dbt deps

    - name: Run DBT Models
      run: dbt run

    - name: Run DBT Tests
      run: dbt test
